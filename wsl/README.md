# 异常排查

## ping 网关或者 wsl 其他发行版本的静态 ip 失败

原因是 WSL2和主机IP不同，且会被Windows Defender当作公网链接屏蔽。但是防火墙并不会组织 wsl 内部的正常网络访问 `apt install` 、`ping baidu.com` 都没有问题，甚至尝试 trace route 时候可以看到第一项可以看到请求经过了wsl网关(172.22.48.1)。   
这时候需要关闭公用网络防火墙(一般windows链接都是专用网络) 或者使用 powershell 管理员模式运行命令行。
```powershell
New-NetFirewallRule -DisplayName "WSL" -Direction Inbound -InterfaceAlias "vEthernet (WSL)" -Action Allow
```
注：需要注意的是虽然我们可以手动浏览添加systems32/wsl.exe到名单中但是并不起作用，没太明白这个命令行的作用 猜测是把wsl网关添加到白名单中的样子 网关也算应用吗在防火墙中？不清楚 。而且删除按钮好像不能删除这条新加wsl的规则。

在控制面板\所有控制面板项\Windows Defender 防火墙\允许的应用 的列表中可以看到新加的 wsl 条目。这个时候再尝试 ping 172.22.48.1 就可以正常了

## wsl 在添加多个操作系统后，有趣的事情发生了。 我安装了 ubuntu 和 debian 两个系统，同时查看 ip addr 可以看到打印的信息一模一样，wsl 的虚拟网卡貌似是共享的。我想尝试配置各自不同的固定IP
结论 ubuntu 和debian 的引用了同一个ip ，但是可以可以尝试自己更改ip。实际上 我尝试 wsl --shutdown 或者重启系统多次后 默认ip（172.22.48.1）都未曾改变过
。下面的内容其实有些多余了，至少也不会有人使用wsl做生产环境上吧
### 1. 修改固定ip
```bash
# 先查看 ip addr
ip addr show eth0
```

显示:

2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1280 qdisc mq state UP group default qlen 1000  
&nbsp;&nbsp;link/ether 00:15:5d:34:c6:68 brd ff:ff:ff:ff:ff:ff  
&nbsp;&nbsp;<font color=green>inet 172.22.52.167/20 brd 172.22.63.255 scope global eth0</font>  
&nbsp;&nbsp;valid_lft forever preferred_lft forever  
&nbsp;&nbsp;inet6 fe80::215:5dff:fe34:c668/64 scope link  
&nbsp;&nbsp;valid_lft forever preferred_lft forever

可以看到当前 IP 是 172.22.52.167/20 可以计算得知  
掩码: 255.255.240.0  
广播: 172.22.63.255  
第一个可用 ip: 172.22.48.1  
最后一个可用 ip: 172.22.63.254
172.22.48.1 现在是网关 选择 172.22.48.2 为第一个可用 ip

```bash
ip route list
```

显示:
default via 172.22.48.1 dev eth0 proto kernel
172.22.48.0/20 dev eth0 proto kernel scope link src 172.22.52.167

```bash
# 删除 ip 再次输出 ip route list 结果为空，ip addr show eth0 显示也少了一行 inet 172.22.52.167/20 brd 172.22.63.255 scope global eth0
sudo ip addr del $(ip addr show eth0 | grep 'inet\b' | awk '{print $2}' | head -n 1) dev eth0
```

再次查看 ip 和ip route

```bash
ip addr show eth0
ip route list # 输出为空
```

```
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1280 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:34:c6:68 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::215:5dff:fe34:c668/64 scope link
       valid_lft forever preferred_lft forever
```

```bash
# 添加固定ip
sudo ip addr add 172.22.48.2/20 broadcast 172.22.63.255 dev eth0
```

再次查看 ip

```bash
ip addr show eth0
```

2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1280 qdisc mq state UP group default qlen 1000  
&nbsp;&nbsp;link/ether 00:15:5d:34:c6:68 brd ff:ff:ff:ff:ff:ff  
&nbsp;&nbsp;<font color=green>inet 172.22.48.2/20 brd 172.22.63.255 scope global eth0</font>  
&nbsp;&nbsp;valid_lft forever preferred_lft forever  
&nbsp;&nbsp;inet6 fe80::215:5dff:fe34:c668/64 scope link  
&nbsp;&nbsp;valid_lft forever preferred_lft forever

再次查看 ip route
```bash
$ ip route list
172.22.48.0/20 dev eth0 proto kernel scope link src 172.22.48.2
```

最后添加默认路由
```bash
sudo ip route add 0.0.0.0/0 via 172.22.48.1 dev eth0
```
再次查看 ip route
```bash
$ ip route list
default via 172.22.48.1 dev eth0
172.22.48.0/20 dev eth0 proto kernel scope link src 172.22.48.2
```


```
### 2. 另外可能有必要修改一下 nameserver 配置 这里我使用的wsl默认网关，所以不需要做任何更改

```bash
sudo vim /etc/resolv.conf
```

```conf
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.22.48.1
# nameserver 1.1.1.1
# nameserver 8.8.8.8
```
注：如果不是配置的 1.1.1.1或者8.8.8.8 在这里 我觉得在windows控制面板\所有控制面板项\网络连接需要给vEthernet (WSL) 配置一下 dns为 1.1.1.1和8.8.8.8为好
因为我有看到说wsl的网速只有外部windows的1/10左右 咨询过 ai问 为什么wsl内网速慢 他给出的答案是 配置dns 这个网速问题 我未曾测试 平常网速还行吧毕竟我有使用代理 但是 github下载即便使用代理网速也只维持在 100-200kb/s 也能接受 总比没有代理时候的 几十kb/s好
还要组织 wsl 修改这个文件 每次启动的时候好像会重写 resolv.conf

```bash
sudo vim /etc/wsl.conf
```

```conf
[boot]
systemd = true

[network]
generateResolvConf = false

[automount]
enabled = true
options = "metadata"
mountFsTab = false
```

重点是 generateResolvConf = false 阻止重新配置 resolv.conf。
上边的 boot 是默认配置 留着也没事[systemd 介绍](https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config#systemd-support)，
下边的 automount 配置好像没有也可以 [automount 介绍](https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config#automount-settings)

### 3.  结尾重点！！！ 以上更改都在当前启动中有效，windows重启或者 wsl重启后都将重置默认配置
WSL2 采用 Hyper-V 的 Internal Virtual Switch，这个虚拟交换机本身是可以设置静态 IP 地址的，但是 WSL2 却自作聪明，在每次全新启动的时候将网络配置恢复成 DHCP，这样不仅可能会造成局域网内网段的冲突，而且对于需要固定地址访问 WSL2 内服务的需求也带来了不少麻烦。

所以要在wsl启动后运行过脚本重新配置
```bash
if [[ $(ip addr show eth0 | grep 'inet ' | awk '{print $2}') != 172.22.48.2/20 ]]; then 
    sudo ip addr del $(ip addr show eth0 | grep 'inet\b' | awk '{print $2}' | head -n 1) dev eth0
    sudo ip addr add 172.22.48.2/20 broadcast 172.22.63.255 dev eth0
    sudo ip route add 0.0.0.0/0 via 172.22.48.1 dev eth0
fi
```
```powershell
wsl -d Ubuntu -u root ip addr del $(ip addr show eth0 ^| grep 'inet\b' ^| awk '{print $2}' ^| head -n 1) dev eth0
wsl -d Ubuntu -u root ip addr add 192.168.50.2/24 broadcast 192.168.50.255 dev eth0
wsl -d Ubuntu -u root ip route add 0.0.0.0/0 via 192.168.50.1 dev eth0
wsl -d Ubuntu -u root echo nameserver 192.168.50.1 ^> /etc/resolv.conf
powershell -c "Get-NetAdapter 'vEthernet (WSL)' | Get-NetIPAddress | Remove-NetIPAddress -Confirm:$False; New-NetIPAddress -IPAddress 192.168.50.1 -PrefixLength 24 -InterfaceAlias 'vEthernet (WSL)'; Get-NetNat | ? Name -Eq WSLNat | Remove-NetNat -Confirm:$False; New-NetNat -Name WSLNat -InternalIPInterfaceAddressPrefix 192.168.50.0/24;"
```
只有改变windows wsl的Ip的时候才需要修改 /etc/wsl.conf和/etc/resolv.conf文件

例如将默认的172.22.48.1改为192.168.50.1
```powershell
Get-NetAdapter 'vEthernet (WSL)' | Get-NetIPAddress | Remove-NetIPAddress -Confirm:$False
New-NetIPAddress -IPAddress 192.168.50.1 -PrefixLength 24 -InterfaceAlias 'vEthernet (WSL)'
Get-NetNat | ? Name -Eq WSLNat | Remove-NetNat -Confirm:$False
New-NetNat -Name WSLNat -InternalIPInterfaceAddressPrefix 192.168.50.0/24;
```
## 配置wsl2 代理
在.bashrc或者.zshrc中添加  
export http_proxy=http://192.168.3.2:7890  
export https_proxy=http://192.168.3.2:7890

### 4.创建开机启动脚本
！！！ 如果安装了 ubuntu debian 本来想 两个系统使用两个不同的ip 但是行不通 无论是在~/.bashrc中设置ip 还是在 启动脚本中设置 都会同时更改两个系统的ip
创建sh脚本
```bash
$ sudo vim /etc/systemd/system/set-static-ip.sh

#!/bin/bash

if [[ $(ip addr show eth0 | grep 'inet ' | awk '{print $2}') != 172.22.48.2/20 ]]; then
    sudo ip addr del $(ip addr show eth0 | grep 'inet\b' | awk '{print $2}' | head -n 1) dev eth0
    sudo ip addr add 172.22.48.2/20 broadcast 172.22.63.255 dev eth0
    sudo ip route add 0.0.0.0/0 via 172.22.48.1 dev eth0
fi
exit 0

$ sudo chmod +x /etc/systemd/system/set-static-ip.sh
```
创建service
```bash
$ sudo vim /etc/systemd/system/set-static-ip.service
[Unit]
Description=My Service
After=network.target

[Service]
ExecStart=/etc/systemd/system/set-static-ip.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
``
重新加载systemd配置：
```bash
sudo systemctl daemon-reload
```
启用并启动服务：
```bash
$ sudo systemctl enable set-static-ip.service
Created symlink /etc/systemd/system/multi-user.target.wants/set-static-ip.service → /etc/systemd/system/set-static-ip.service.
$ sudo systemctl start set-static-ip.service
```
## 查询github.com 和raw.githubusercontent.com ip
https://sites.ipaddress.com/github.com/
https://sites.ipaddress.com/raw.githubusercontent.com/

